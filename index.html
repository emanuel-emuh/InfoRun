<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Info-Run: CorridÃ£o</title>
    <link rel="stylesheet" href="static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <div class="container">
        <header>
            <h1>ğŸƒ Info-Run</h1>
        </header>

        <div id="boxRecordista" class="destaque-dia" style="display: none;">
            <div class="destaque-titulo">ğŸ”¥ Recordista de Hoje</div>
            <div id="txtRecordista" class="destaque-nome">--</div>
            <div id="txtRecordistaKm" style="font-size: 1rem;">0 km</div>
        </div>

        <div class="meta-box">
            <div class="meta-texto">
                <span>Progresso do Grupo</span>
                <span id="txtMeta">0 / 500 km</span>
            </div>
            <div class="progress-container">
                <div id="barraProgresso" class="progress-bar"></div>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“ˆ EvoluÃ§Ã£o Mensal</h3>
            <div style="position: relative; height: 300px; width: 100%;">
                <canvas id="graficoEvolucao"></canvas>
            </div>
        </div>

        <div class="card">
            <h3>Registrar Nova Corrida</h3>
            <div class="form-group">
                <select id="atletaInput">
                    <option value="" disabled selected>Selecionar Atleta...</option>
                    <option value="Pjr">Pjrâš¡ </option>
                    <option value="PL">PLğŸŠâ€‹</option>
                    <option value="Saulo">SauloğŸ”¥</option>
                    <option value="Gustavo">GustavoğŸº</option>
                    <option value="Matheus">MatheusğŸ¦„â€‹</option>
                    <option value="Gabriel">GabrielğŸ’…</option>
                    <option value="Emuh">EmuhğŸ’¢</option>
                    <option value="Maumau">MaumauğŸ˜ˆ</option>
                    <option value="Yago">Yagoâ€‹ğŸ¢â€‹</option>
                </select>
                <input type="number" step="0.01" id="kmInput" placeholder="DistÃ¢ncia (KM)">
            </div>


            <button id="btnRegistrar" class="btn-registrar">ğŸš€ Registrar KM</button>
        </div>

        <div class="card">
            <h3>ğŸ† Ranking do MÃªs</h3>
            <table id="tabelaRanking">
                <thead>
                    <tr>
                        <th width="15%">Pos</th>
                        <th>Atleta</th>
                        <th width="30%">Total</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="3">Carregando...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==================================================================
        // SUA CONFIGURAÃ‡ÃƒO DO FIREBASE (JÃ INCLUÃDA)
        // ==================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAQp-fQCt3y6K-TYhKqJUNPH1ZMmeqaJa4",
            authDomain: "info-run-ca27e.firebaseapp.com",
            projectId: "info-run-ca27e",
            storageBucket: "info-run-ca27e.firebasestorage.app",
            messagingSenderId: "183190789446",
            appId: "1:183190789446:web:41470996258c4b8afb9947"
        };
        // ==================================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const META_MENSAL = 500; 

        // Datas
        const dataHojeObj = new Date();
        const mesAtual = dataHojeObj.getFullYear() + "-" + String(dataHojeObj.getMonth() + 1).padStart(2, '0');
        const diaHojeString = dataHojeObj.toDateString(); 
        const diaHojeNumero = dataHojeObj.getDate(); // Ex: 1, 2, 15...

        // VariÃ¡vel global para o GrÃ¡fico (para poder atualizar/destruir)
        let chartInstance = null;

        // CORES PARA OS ATLETAS (Adicionei cores neon para combinar com o tema)
        const coresAtletas = {
            "Pjr": "#FF5733", "PL": "#33FF57", "Saulo": "#3357FF", 
            "Gustavo": "#FF33F6", "Matheus": "#33FFF6", "Gabriel": "#F6FF33",
            "Emuh": "#FF8C33", "Maumau": "#9d4edd", "Yago": "#ffffff"
        };

        const q = query(collection(db, "corridas"), where("data", "==", mesAtual), orderBy("timestamp", "asc"));
        
        onSnapshot(q, (snapshot) => {
            const listaRanking = document.getElementById('tabelaRanking').querySelector('tbody');
            
            let totais = {}; 
            let somaGrupo = 0;
            let melhorDoDia = { nome: "", km: 0 };
            
            // Estrutura para o GrÃ¡fico: { "Emuh": [0, 5, 5, 10...], "PL": [0, 0, 2...] }
            let dadosDiarios = {};
            // Cria array vazio de dias para cada atleta cadastrado no select
            const opcoesSelect = document.getElementById('atletaInput').options;
            for (let i = 0; i < opcoesSelect.length; i++) {
                if(opcoesSelect[i].value) {
                    dadosDiarios[opcoesSelect[i].value] = new Array(diaHojeNumero + 1).fill(0);
                }
            }

            snapshot.forEach((documento) => {
                const dados = documento.data();
                
                // 1. Soma Totais (Ranking e Meta)
                if (!totais[dados.atleta]) totais[dados.atleta] = 0;
                totais[dados.atleta] += dados.km;
                somaGrupo += dados.km;

                // 2. Recordista do Dia
                if (dados.timestamp) {
                    const dataObj = dados.timestamp.toDate();
                    const dataCorrida = dataObj.toDateString();
                    const diaCorrida = dataObj.getDate();

                    if (dataCorrida === diaHojeString) {
                        if (dados.km > melhorDoDia.km) {
                            melhorDoDia = { nome: dados.atleta, km: dados.km };
                        }
                    }

                    // 3. Prepara dados do GrÃ¡fico
                    // Se a corrida foi atÃ© hoje, soma no dia correspondente
                    if (diaCorrida <= diaHojeNumero && dadosDiarios[dados.atleta]) {
                        dadosDiarios[dados.atleta][diaCorrida] += dados.km;
                    }
                }
            });

            // --- ATUALIZA META E RECORDISTA ---
            const porcentagem = (somaGrupo / META_MENSAL) * 100;
            document.getElementById('barraProgresso').style.width = (porcentagem > 100 ? 100 : porcentagem) + "%";
            document.getElementById('txtMeta').innerText = `${somaGrupo.toFixed(1)} / ${META_MENSAL} km`;

            const boxRecordista = document.getElementById('boxRecordista');
            if (melhorDoDia.km > 0) {
                boxRecordista.style.display = "block";
                document.getElementById('txtRecordista').innerText = `ğŸ‘‘ ${melhorDoDia.nome}`;
                document.getElementById('txtRecordistaKm').innerText = `Correu ${melhorDoDia.km} km hoje!`;
            } else {
                boxRecordista.style.display = "none"; 
            }

            // --- ATUALIZA RANKING ---
            listaRanking.innerHTML = "";
            const rankingOrdenado = Object.entries(totais).sort((a, b) => b[1] - a[1]);

            if (rankingOrdenado.length === 0) {
                listaRanking.innerHTML = "<tr><td colspan='3' style='text-align:center'>NinguÃ©m correu ainda ğŸ˜´</td></tr>";
            } else {
                rankingOrdenado.forEach((item, index) => {
                    const nome = item[0];
                    const total = item[1].toFixed(2);
                    const medalha = index === 0 ? "ğŸ¥‡ " : (index === 1 ? "ğŸ¥ˆ " : (index === 2 ? "ğŸ¥‰ " : ""));
                    const classe = index === 0 ? "posicao-1" : "";
                    
                    const linhaRanking = `<tr class="${classe}"><td>#${index + 1}</td><td>${medalha}${nome}</td><td>${total} km</td></tr>`;
                    listaRanking.innerHTML += linhaRanking;
                });
            }

            // --- GERA O GRÃFICO ---
            atualizarGrafico(dadosDiarios);
        });

        function atualizarGrafico(dadosBrutos) {
            // 1. Cria os labels (Dias 1, 2, 3... atÃ© Hoje)
            const labels = [];
            for(let i = 1; i <= diaHojeNumero; i++) labels.push(`Dia ${i}`);

            // 2. Transforma os dados diÃ¡rios em ACUMULADOS
            // Ex: Dia 1 (5km), Dia 2 (0km) -> Vira: Dia 1 (5km), Dia 2 (5km)
            const datasets = [];
            
            for (const [atleta, corridasPorDia] of Object.entries(dadosBrutos)) {
                let acumulado = 0;
                let dadosAcumulados = [];
                let correuNoMes = false;

                // ComeÃ§a do dia 1 (ignora o Ã­ndice 0)
                for(let i = 1; i <= diaHojeNumero; i++) {
                    acumulado += corridasPorDia[i];
                    dadosAcumulados.push(acumulado);
                    if(acumulado > 0) correuNoMes = true;
                }

                // SÃ³ mostra no grÃ¡fico quem jÃ¡ correu
                if(correuNoMes) {
                    datasets.push({
                        label: atleta,
                        data: dadosAcumulados,
                        borderColor: coresAtletas[atleta] || "#999", // Cor fixa ou cinza
                        backgroundColor: coresAtletas[atleta] || "#999",
                        borderWidth: 2,
                        tension: 0.3, // Deixa a linha curva
                        pointRadius: 3
                    });
                }
            }

            // 3. Renderiza o Chart.js
            const ctx = document.getElementById('graficoEvolucao');
            
            // Se jÃ¡ existe grÃ¡fico, destroi antes de criar novo (pra nÃ£o bugar)
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#fff' } } // Legenda branca
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: '#444' }, // Grade escura
                            ticks: { color: '#ccc' }
                        },
                        x: {
                            grid: { color: '#444' },
                            ticks: { color: '#ccc' }
                        }
                    }
                }
            });
        }

        // Registrar
        document.getElementById('btnRegistrar').addEventListener('click', async () => {
            const atleta = document.getElementById('atletaInput').value;
            const valorInput = document.getElementById('kmInput').value;
            const km = parseFloat(valorInput);

            if (!atleta || valorInput === "") { 
                alert("Selecione um atleta e digite os KMs!"); return; 
            }

            try {
                await addDoc(collection(db, "corridas"), {
                    atleta: atleta, km: km, data: mesAtual, timestamp: new Date()
                });
                alert("âœ… Registrado!");
                document.getElementById('kmInput').value = ""; 
            } catch (e) {
                console.error(e);
                alert("Erro ao salvar.");
            }
        });
    </script>
</body>
</html>