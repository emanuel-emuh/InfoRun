<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Info-Run: Firebase</title>
    <link rel="stylesheet" href="static/css/style.css">
</head>
<body>

    <div class="container">
        <header>
            <h1>üèÉ Info-Run</h1>
            <p>Conectado ao Firebase üî•</p>
        </header>

        <div class="card">
            <h3>Registrar Nova Corrida</h3>
            <div class="form-group">
                <select id="atletaInput">
                    <option value="" disabled selected>Selecionar Atleta...</option>
                    <option value="Pjr">Pjr</option>
                    <option value="PL">PL</option>
                    <option value="Saulo">Saulo</option>
                    <option value="Gustavo">Gustavo</option>
                    <option value="Matheus">Matheus</option>
                    <option value="Gabriel">Gabriel</option>
                    <option value="Emuh">Emuh</option>
                </select>
                <input type="number" step="0.01" id="kmInput" placeholder="Dist√¢ncia (KM)">
            </div>
            <button id="btnRegistrar" class="btn-registrar">üöÄ Registrar KM</button>
        </div>

        <div class="card">
            <h3>üèÜ Ranking do M√™s</h3>
            <table id="tabelaRanking">
                <thead>
                    <tr>
                        <th width="15%">Pos</th>
                        <th>Atleta</th>
                        <th width="30%">Total</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="3">Carregando...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="card">
            <h3>üìù Hist√≥rico Recente</h3>
            <table id="tabelaHistorico">
                <thead>
                    <tr>
                        <th>Atleta</th>
                        <th>KM</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        // 1. Importa as ferramentas do Firebase (N√£o mexa aqui)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==================================================================
        // üëáüëáüëá √ÅREA DE CONFIGURA√á√ÉO (COLE SEU C√ìDIGO AQUI) üëáüëáüëá
        // ==================================================================
        
        const firebaseConfig = {
            apiKey: "COLE_SUA_API_KEY_AQUI",
            authDomain: "COLE_SEU_AUTH_DOMAIN_AQUI",
            projectId: "COLE_SEU_PROJECT_ID_AQUI",
            storageBucket: "COLE_SEU_STORAGE_BUCKET_AQUI",
            messagingSenderId: "COLE_SEU_SENDER_ID_AQUI",
            appId: "COLE_SEU_APP_ID_AQUI"
        };

        // üëÜüëÜüëÜ FIM DA √ÅREA DE CONFIGURA√á√ÉO üëÜüëÜüëÜ
        // ==================================================================

        // 2. Inicia o Banco de Dados
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 3. Define o M√™s Atual (para filtrar o ranking)
        const dataHoje = new Date();
        const mesAtual = dataHoje.getFullYear() + "-" + String(dataHoje.getMonth() + 1).padStart(2, '0');

        // 4. L√≥gica para LER os dados em Tempo Real
        const q = query(collection(db, "corridas"), where("data", "==", mesAtual), orderBy("timestamp", "desc"));
        
        onSnapshot(q, (snapshot) => {
            const listaHistorico = document.getElementById('tabelaHistorico').querySelector('tbody');
            const listaRanking = document.getElementById('tabelaRanking').querySelector('tbody');
            
            listaHistorico.innerHTML = "";
            listaRanking.innerHTML = "";

            let totais = {}; // Objeto para somar os KMs de cada um

            snapshot.forEach((documento) => {
                const dados = documento.data();
                const id = documento.id;
                
                // A. Preenche a tabela de Hist√≥rico
                const linhaHistorico = `
                    <tr>
                        <td>${dados.atleta}</td>
                        <td>${dados.km} km</td>
                        <td><button class="btn-delete" data-id="${id}">Excluir</button></td>
                    </tr>
                `;
                listaHistorico.innerHTML += linhaHistorico;

                // B. Soma os KMs para o Ranking
                if (!totais[dados.atleta]) totais[dados.atleta] = 0;
                totais[dados.atleta] += dados.km;
            });

            // C. Ordena e Mostra o Ranking
            const rankingOrdenado = Object.entries(totais).sort((a, b) => b[1] - a[1]);

            if (rankingOrdenado.length === 0) {
                listaRanking.innerHTML = "<tr><td colspan='3' style='text-align:center'>Ningu√©m correu este m√™s ainda üò¥</td></tr>";
            } else {
                rankingOrdenado.forEach((item, index) => {
                    const nome = item[0];
                    const total = item[1].toFixed(2);
                    const medalha = index === 0 ? "üëë " : ""; // Coroa pro primeiro
                    const classe = index === 0 ? "posicao-1" : "";
                    
                    const linhaRanking = `
                        <tr class="${classe}">
                            <td>#${index + 1}</td>
                            <td>${medalha}${nome}</td>
                            <td>${total} km</td>
                        </tr>
                    `;
                    listaRanking.innerHTML += linhaRanking;
                });
            }

            // D. Ativa os bot√µes de excluir (L√≥gica extra para funcionar com type=module)
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const idParaDeletar = e.target.getAttribute('data-id');
                    if(confirm("Tem certeza que quer apagar esse registro?")) {
                        await deleteDoc(doc(db, "corridas", idParaDeletar));
                    }
                });
            });
        });

        // 5. L√≥gica para REGISTRAR nova corrida (Bot√£o)
        document.getElementById('btnRegistrar').addEventListener('click', async () => {
            const atleta = document.getElementById('atletaInput').value;
            const km = parseFloat(document.getElementById('kmInput').value);

            if (!atleta || !km) { 
                alert("Por favor, selecione um atleta e digite os KMs!"); 
                return; 
            }

            try {
                await addDoc(collection(db, "corridas"), {
                    atleta: atleta,
                    km: km,
                    data: mesAtual, // Salva o m√™s atual ("2025-09")
                    timestamp: new Date() // Salva a hora exata
                });
                alert("‚úÖ Corrida registrada com sucesso!");
                document.getElementById('kmInput').value = ""; // Limpa o campo
            } catch (e) {
                console.error("Erro ao salvar: ", e);
                alert("Erro ao salvar. Verifique se copiou a Configura√ß√£o do Firebase certa!");
            }
        });

    </script>
</body>
</html>
