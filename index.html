<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Info-Run: Dashboard</title>
    <link rel="stylesheet" href="static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <div class="container">
        <header>
            <h1>üèÉ Info-Run</h1>
        </header>

        <div class="dashboard-grid">

            <div class="top-row">
                <div id="boxRecordista" class="destaque-dia" style="display: none;">
                    <div class="destaque-titulo">üî• Recordista de Hoje</div>
                    <div id="txtRecordista" class="destaque-nome">--</div>
                    <div id="txtRecordistaKm" style="font-size: 1rem;">0 km</div>
                </div>
                <div class="meta-box">
                    <div class="meta-texto">
                        <span>Progresso do Grupo</span>
                        <span id="txtMeta">0 / 500 km</span>
                    </div>
                    <div class="progress-container">
                        <div id="barraProgresso" class="progress-bar"></div>
                    </div>
                </div>
            </div>

            <div class="left-col">
                <div class="card">
                    <h3>Registrar Nova Corrida</h3>
                    <div class="form-group">
                        <select id="atletaInput">
                            <option value="" disabled selected>Selecionar Atleta...</option>
                            <option value="Pjr">Pjr</option>
                            <option value="PL">PL</option>
                            <option value="Saulo">Saulo</option>
                            <option value="Gustavo">Gustavo</option>
                            <option value="Matheus">Matheus</option>
                            <option value="Gabriel">Gabriel</option>
                            <option value="Emuh">Emuh</option>
                            <option value="Maumau">Maumau</option>
                            <option value="Yago">Yago</option>
                        </select>
                        <input type="number" step="0.01" id="kmInput" placeholder="Dist√¢ncia (KM)">
                    </div>
                    <button id="btnRegistrar" class="btn-registrar">üöÄ Registrar KM</button>
                </div>

                <div class="card">
                    <h3>üí¨ Mural da Galera</h3>
                    <div id="boxMensagens" class="mural-container">
                        <div style="text-align:center; color:#666; font-size:0.8rem; padding:20px;">
                            Carregando...
                        </div>
                    </div>
                    <div style="margin-top: 10px; border-top: 1px solid #333; padding-top: 10px;">
                        <input type="text" id="inputMsg" placeholder="Mensagem..." maxlength="140">
                        <button id="btnEnviarMsg" class="btn-enviar-msg">ENVIAR üì®</button>
                    </div>
                </div>
            </div>

            <div class="right-col">
                
                <div class="card" style="border: 2px solid #9d4edd; box-shadow: 0 0 15px rgba(157, 78, 221, 0.2);">
                    <h3>üèÜ Ranking do M√™s</h3>
                    
                    <div style="overflow-x: auto; width: 100%;"> 
                        <table id="tabelaRanking" style="min-width: 400px;"> <thead>
                                <tr>
                                    <th width="10%">POS</th>
                                    <th width="25%">NOME</th>
                                    <th>DISTANCIAS</th>
                                    <th style="text-align: center;">ATIVIDADES</th>
                                    <th>M√âDIA P/ ATV</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="5">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>

                </div>

                <div class="card">
                    <h3>üìà Evolu√ß√£o Mensal</h3>
                    <div style="position: relative; height: 250px; width: 100%;">
                        <canvas id="graficoEvolucao"></canvas>
                    </div>
                </div>

            </div>

        </div> </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==================================================================
        // SUA CONFIGURA√á√ÉO
        // ==================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAQp-fQCt3y6K-TYhKqJUNPH1ZMmeqaJa4",
            authDomain: "info-run-ca27e.firebaseapp.com",
            projectId: "info-run-ca27e",
            storageBucket: "info-run-ca27e.firebasestorage.app",
            messagingSenderId: "183190789446",
            appId: "1:183190789446:web:41470996258c4b8afb9947"
        };
        // ==================================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const META_MENSAL = 500; 

        // Datas
        const dataHojeObj = new Date();
        const mesAtual = dataHojeObj.getFullYear() + "-" + String(dataHojeObj.getMonth() + 1).padStart(2, '0');
        const diaHojeString = dataHojeObj.toDateString(); 
        const diaHojeNumero = dataHojeObj.getDate(); 

        let chartInstance = null;
        const coresAtletas = {
            "Pjr": "#FF5733", "PL": "#33FF57", "Saulo": "#3357FF", 
            "Gustavo": "#FF33F6", "Matheus": "#33FFF6", "Gabriel": "#F6FF33",
            "Emuh": "#FF8C33", "Maumau": "#9d4edd", "Yago": "#ffffff"
        };

        // 1. DADOS DE CORRIDAS
        const q = query(collection(db, "corridas"), where("data", "==", mesAtual), orderBy("timestamp", "asc"));
        
        onSnapshot(q, (snapshot) => {
            const listaRanking = document.getElementById('tabelaRanking').querySelector('tbody');
            
            // AGORA 'STATS' GUARDA KM E CONTAGEM
            let stats = {}; 
            let somaGrupo = 0;
            let melhorDoDia = { nome: "", km: 0 };
            let dadosDiarios = {};
            
            const opcoesSelect = document.getElementById('atletaInput').options;
            for (let i = 0; i < opcoesSelect.length; i++) {
                if(opcoesSelect[i].value) dadosDiarios[opcoesSelect[i].value] = new Array(diaHojeNumero + 1).fill(0);
            }

            snapshot.forEach((documento) => {
                const dados = documento.data();
                const nomeAtleta = dados.atleta.trim(); // Limpa espa√ßos

                // L√≥gica de Estat√≠stica (Soma KM e Conta +1 Atividade)
                if (!stats[nomeAtleta]) {
                    stats[nomeAtleta] = { km: 0, count: 0 };
                }
                stats[nomeAtleta].km += dados.km;
                stats[nomeAtleta].count += 1;

                somaGrupo += dados.km;

                // L√≥gica do Gr√°fico e Recordista
                if (dados.timestamp) {
                    const dataObj = dados.timestamp.toDate();
                    const dataCorrida = dataObj.toDateString();
                    const diaCorrida = dataObj.getDate();

                    if (dataCorrida === diaHojeString) {
                        if (dados.km > melhorDoDia.km) melhorDoDia = { nome: nomeAtleta, km: dados.km };
                    }
                    if (diaCorrida <= diaHojeNumero && dadosDiarios[nomeAtleta]) {
                        dadosDiarios[nomeAtleta][diaCorrida] += dados.km;
                    }
                }
            });

            // Atualiza Meta
            const porcentagem = (somaGrupo / META_MENSAL) * 100;
            document.getElementById('barraProgresso').style.width = (porcentagem > 100 ? 100 : porcentagem) + "%";
            document.getElementById('txtMeta').innerText = `${somaGrupo.toFixed(1)} / ${META_MENSAL} km`;

            // Atualiza Recordista
            const boxRecordista = document.getElementById('boxRecordista');
            if (melhorDoDia.km > 0) {
                boxRecordista.style.display = "block";
                document.getElementById('txtRecordista').innerText = `üëë ${melhorDoDia.nome}`;
                document.getElementById('txtRecordistaKm').innerText = `Correu ${melhorDoDia.km} km hoje!`;
            } else {
                boxRecordista.style.display = "none"; 
            }

            // --- GERA O RANKING DETALHADO ---
            listaRanking.innerHTML = "";
            // Ordena por KM Total
            const rankingOrdenado = Object.entries(stats).sort((a, b) => b[1].km - a[1].km);

            if (rankingOrdenado.length === 0) {
                listaRanking.innerHTML = "<tr><td colspan='5' style='text-align:center'>Ningu√©m correu ainda üò¥</td></tr>";
            } else {
                rankingOrdenado.forEach((item, index) => {
                    const nome = item[0];
                    const dadosAtleta = item[1];
                    
                    const totalKm = dadosAtleta.km.toFixed(2);
                    const atividades = dadosAtleta.count;
                    // Calcula M√©dia (evita divis√£o por zero)
                    const media = atividades > 0 ? (dadosAtleta.km / atividades).toFixed(2) : "0.00";

                    let medalha = "";
                    if(index === 0) medalha = "ü•á";
                    else if(index === 1) medalha = "ü•à";
                    else if(index === 2) medalha = "ü•â";
                    
                    const classe = index === 0 ? "posicao-1" : "";
                    
                    const linhaRanking = `
                        <tr class="${classe}">
                            <td>${medalha} ${index + 1}¬∫</td>
                            <td style="font-weight:bold;">${nome}</td>
                            <td>${totalKm}</td>
                            <td style="text-align: center;">${atividades}</td>
                            <td>${media}</td>
                        </tr>
                    `;
                    listaRanking.innerHTML += linhaRanking;
                });
            }
            atualizarGrafico(dadosDiarios);
        });

        // 2. MURAL
        const qMural = query(collection(db, "mural"), orderBy("timestamp", "desc"), limit(20));
        onSnapshot(qMural, (snapshot) => {
            const box = document.getElementById('boxMensagens');
            box.innerHTML = ""; 
            if (snapshot.empty) { box.innerHTML = "<div style='text-align:center;color:#666;font-size:0.8rem;padding:20px;'>Mural vazio...</div>"; return; }

            snapshot.forEach((doc) => {
                const msg = doc.data();
                let hora = "--:--";
                if(msg.timestamp) hora = msg.timestamp.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                box.innerHTML += `
                    <div class="msg-card">
                        <div class="msg-header"><span class="msg-autor">${msg.atleta}</span><span>${hora}</span></div>
                        <div class="msg-texto">${msg.texto}</div>
                    </div>
                `;
            });
        });

        // 3. EVENTOS
        document.getElementById('inputMsg').addEventListener('focus', () => {
            const atleta = document.getElementById('atletaInput').value;
            if (!atleta) {
                alert("‚ö†Ô∏è Selecione seu nome no 'Registrar' antes de digitar!");
                document.getElementById('inputMsg').blur();
                document.getElementById('atletaInput').focus();
            }
        });

        document.getElementById('btnEnviarMsg').addEventListener('click', async () => {
            const atleta = document.getElementById('atletaInput').value;
            const texto = document.getElementById('inputMsg').value;
            if (!atleta || !texto) return;
            try {
                document.getElementById('btnEnviarMsg').innerText = "...";
                await addDoc(collection(db, "mural"), { atleta, texto, timestamp: new Date() });
                document.getElementById('inputMsg').value = "";
                document.getElementById('btnEnviarMsg').innerText = "ENVIAR üì®";
            } catch (e) { console.error(e); }
        });

        document.getElementById('btnRegistrar').addEventListener('click', async () => {
            const atleta = document.getElementById('atletaInput').value;
            const valorInput = document.getElementById('kmInput').value;
            const km = parseFloat(valorInput);
            if (!atleta || valorInput === "") { alert("Preencha tudo!"); return; }
            try {
                await addDoc(collection(db, "corridas"), { atleta, km, data: mesAtual, timestamp: new Date() });
                alert("‚úÖ Registrado!"); document.getElementById('kmInput').value = ""; 
            } catch (e) { console.error(e); alert("Erro ao salvar."); }
        });

        function atualizarGrafico(dadosBrutos) {
            const labels = [];
            for(let i = 1; i <= diaHojeNumero; i++) labels.push(`Dia ${i}`);
            const datasets = [];
            for (const [atleta, corridasPorDia] of Object.entries(dadosBrutos)) {
                let acumulado = 0;
                let dadosAcumulados = [];
                let correuNoMes = false;
                for(let i = 1; i <= diaHojeNumero; i++) {
                    acumulado += corridasPorDia[i];
                    dadosAcumulados.push(acumulado);
                    if(acumulado > 0) correuNoMes = true;
                }
                if(correuNoMes) {
                    datasets.push({
                        label: atleta, data: dadosAcumulados,
                        borderColor: coresAtletas[atleta] || "#999", backgroundColor: coresAtletas[atleta] || "#999",
                        borderWidth: 2, tension: 0.3, pointRadius: 3
                    });
                }
            }
            const ctx = document.getElementById('graficoEvolucao');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line', data: { labels: labels, datasets: datasets },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#fff' } } }, scales: { y: { beginAtZero: true, grid: { color: '#444' }, ticks: { color: '#ccc' } }, x: { grid: { color: '#444' }, ticks: { color: '#ccc' } } } }
            });
        }
    </script>
</body>
</html>